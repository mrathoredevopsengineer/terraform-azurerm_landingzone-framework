trigger:
  branches:
    include:
    - main
    - feature/*
    
jobs:
- job: InitPlan
  pool: devops
  steps:
  - task: TerraformInstaller@1
    inputs:
      terraformVersion: 'latest'


  - task: TerraformTask@5
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: '$(System.DefaultWorkingDirectory)\environments'
      backendServiceArm: 'secret'
      backendAzureRmStorageAccountName: 'remotestatefile'
      backendAzureRmContainerName: 'container'
      backendAzureRmKey: 'terraform-loop.tfstate'


  - task: TerraformTask@5
    inputs:
      provider: 'azurerm'
      command: 'plan'
      workingDirectory: '$(System.DefaultWorkingDirectory)\environments'
      environmentServiceNameAzureRM: 'secret'



- job: Apply
  displayName: Apply
  dependsOn: InitPlan
  pool: devops
  steps:
  - task: TerraformTask@5
    inputs:
      provider: 'azurerm'
      command: 'init'
      workingDirectory: '$(System.DefaultWorkingDirectory)\environments'
      backendServiceArm: 'secret'
      backendAzureRmStorageAccountName: 'remotestatefile'
      backendAzureRmContainerName: 'container'
      backendAzureRmKey: 'terraform-loop.tfstate'
  - task: TerraformTask@5
    inputs:
      provider: 'azurerm'
      command: 'apply'
      workingDirectory: '$(System.DefaultWorkingDirectory)\environments'
      commandOptions: '--auto-apporve'
      environmentServiceNameAzureRM: 'secret'